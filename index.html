<!doctype html>
<html lang="bg">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>–°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç ‚Äì –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ —Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç (GPS) –æ—Ç slavi104</title>
    <meta name="theme-color" content="#0b1520">
    <meta name="description" content="–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ —Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç –ø–æ GPS –æ—Ç slavi104. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∏ —Å–ø–∏—Ä–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏ —É—á–∞—Å—Ç—ä—Ü–∏ (–ê–ú ‚Äû–¢—Ä–∞–∫–∏—è", ‚Äû–•–µ–º—É—Å", ‚Äû–°—Ç—Ä—É–º–∞" –∏ –¥—Ä.). –†–∞–±–æ—Ç–∏ –æ—Ñ–ª–∞–π–Ω —Å–ª–µ–¥ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.">
    <meta name="keywords" content="—Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç, GPS, –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä, –ë—ä–ª–≥–∞—Ä–∏—è, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—Ç–∞, AM –¢—Ä–∞–∫–∏—è, –•–µ–º—É—Å, –°—Ç—Ä—É–º–∞">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/favicon.svg">
    <link rel="canonical" href="https://sredna-skorost.online/">
    <link rel="alternate" href="https://sredna-skorost.online/" hreflang="bg">
    <meta property="og:locale" content="bg_BG">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="–°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç –æ—Ç slavi104">
    <meta property="og:title" content="–°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç ‚Äì –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ —Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç (GPS) –æ—Ç slavi104">
    <meta property="og:description" content="–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ —Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç –ø–æ GPS. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä—Ç–∏—Ä–∞/—Å–ø–∏—Ä–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏ —É—á–∞—Å—Ç—ä—Ü–∏. –†–∞–±–æ—Ç–∏ –æ—Ñ–ª–∞–π–Ω.">
    <meta property="og:url" content="https://sredna-skorost.online/">
    <meta property="og:image" content="/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="–°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç ‚Äì –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ —Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç (GPS) –æ—Ç slavi104">
    <meta name="twitter:description" content="–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ —Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç –ø–æ GPS. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä—Ç–∏—Ä–∞/—Å–ø–∏—Ä–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏ —É—á–∞—Å—Ç—ä—Ü–∏. –†–∞–±–æ—Ç–∏ –æ—Ñ–ª–∞–π–Ω.">
    <meta name="twitter:image" content="/og-image.png">
    <meta name="google-site-verification" content="REPLACE_WITH_GSC_TOKEN">
    <meta name="google-adsense-account" content="ca-pub-5938719335702831">
    <script>
    (function(){
        try {
            var url = (location && location.origin ? location.origin : '') + (location && location.pathname ? location.pathname : '/');
            var canon = document.querySelector('link[rel="canonical"]'); if(canon && url) canon.setAttribute('href', url);
            var ogUrl = document.querySelector('meta[property="og:url"]'); if(ogUrl && url) ogUrl.setAttribute('content', url);
        } catch(e) {}
    })();
    </script>
    <style>
        :root {
            --bg:#0b1520;        /* deep dark */
            --panel:#111b27;     /* card */
            --muted:#7a8a9a;     /* text secondary */
            --accent:#22c55e;    /* green */
            --accent-weak:#16a34a;
            --danger:#ef4444;
            --text-primary:#e6edf3;
            --text-secondary:#d9e3ea;
            --border:rgba(255,255,255,.04);
            --border-strong:rgba(255,255,255,.08);
        }
        
        [data-theme="light"] {
            --bg:#f8fafc;        /* light background */
            --panel:#ffffff;     /* white card */
            --muted:#64748b;     /* muted text */
            --accent:#22c55e;    /* green */
            --accent-weak:#16a34a;
            --danger:#ef4444;
            --text-primary:#1e293b;
            --text-secondary:#334155;
            --border:rgba(0,0,0,.06);
            --border-strong:rgba(0,0,0,.12);
        }
        html,body { height:100%; }
        body {
            margin:0; background:var(--bg); color:var(--text-primary); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; -webkit-font-smoothing:antialiased; display:flex; flex-direction:column; align-items:center; }
        .container { width:100%; max-width:720px; padding:16px; box-sizing:border-box; }
        .card { background:var(--panel); border-radius:16px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.15); border:1px solid var(--border); }
        #avgCard { margin-bottom:20px; }
        .row { display:flex; gap:16px; }
        .center { text-align:center; }
        .title { display:flex; align-items:center; gap:8px; color:var(--muted); font-weight:600; letter-spacing:.2px; }
        .big { font-size:120px; font-weight:800; color:#22c55e; line-height:1; }
        .big .unit { font-size:32px; font-weight:700; color:#b9d3c2; }
        .medium { font-size:54px; font-weight:800; color:#22c55e; }
        .muted { color:var(--muted); }
        .kpis { display:flex; justify-content:space-between; gap:12px; font-weight:700; }
        .kpis .box { flex:1; text-align:center; padding:14px 10px; border:1px solid var(--border); border-radius:12px; background:var(--bg); }
        .btn { border:none; border-radius:14px; padding:16px 18px; font-weight:800; font-size:18px; color:#07130c; background:linear-gradient(180deg,#34d061,#18b74f); width:100%; display:flex; align-items:center; justify-content:center; gap:10px; }
        .btn:disabled { filter:grayscale(.3) brightness(.8); opacity:.7; }
        .btn.secondary { background:var(--panel); color:var(--text-secondary); border:1px solid var(--border-strong); }
        .btn.danger { background:linear-gradient(180deg,#ef4444,#dc2626); color:#fff; }
        .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(34,197,94,.12); color:#a7f3d0; font-weight:700; font-size:14px; }
        .rangeBox { margin-top:16px; padding:14px 16px; background:var(--bg); border:1px solid var(--border); border-radius:12px; transition:background .2s, border-color .2s, box-shadow .2s; }
        .rangeBox.active { background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.55); box-shadow:0 0 0 2px rgba(34,197,94,.15) inset; }
        .ad { margin:14px 0; background:#0e171f; border:1px dashed rgba(255,255,255,.18); border-radius:12px; color:#89a3b5; padding:16px; text-align:center; }
        .footer { color:var(--muted); font-size:12px; text-align:center; padding:12px 0 24px; }
        .theme-toggle { position:fixed; top:16px; right:16px; background:var(--panel); border:2px solid var(--accent); border-radius:50px; padding:8px; cursor:pointer; z-index:1000; transition:all .2s; box-shadow:0 2px 8px rgba(34,197,94,0.3); }
        .theme-toggle:hover { background:var(--accent); color:white; }
        .theme-toggle svg { width:20px; height:20px; }
        @media (max-width:420px){ .big{font-size:96px;} .medium{font-size:42px;} }
        /* Ranges table */
        table.dataTable { width:100%; border-collapse:collapse; border-spacing:0; }
        table.dataTable thead th { background:var(--bg); color:var(--text-secondary); text-align:left; font-weight:800; font-size:12px; padding:8px 10px; border-bottom:1px solid var(--border); }
        table.dataTable tbody td { padding:8px 10px; border-bottom:1px solid var(--border); font-weight:600; color:var(--text-secondary); font-size:12px; white-space:normal; word-break:break-word; }
        table.dataTable tbody tr:nth-child(odd) td { background:var(--bg); }
        table.dataTable tbody tr.active td { background:rgba(34,197,94,.12); color:#c6f3d7; }
        @media (max-width:420px){
            table.dataTable thead th, table.dataTable tbody td { padding:6px 8px; font-size:11px; }
        }
        /* Cookie consent banner */
        .cookie-banner { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:500px; background:var(--panel); border:1px solid var(--border-strong); border-radius:16px; padding:20px; display:flex; flex-direction:column; gap:16px; box-shadow:0 20px 40px rgba(0,0,0,.3); z-index:9999; }
        .cookie-banner .text { color:var(--text-secondary); font-size:16px; text-align:center; line-height:1.5; }
        .cookie-banner .actions { display:flex; gap:12px; justify-content:center; }
        .btn.inline { padding:10px 14px; font-size:14px; }
        a { color:#93c5fd; text-decoration:none; }
        a:hover { text-decoration:underline; }
    </style>
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "–°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä –æ—Ç slavi104",
      "url": "https://sredna-skorost.online/",
      "inLanguage": "bg",
      "description": "–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ —Å—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç –ø–æ GPS. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∏ —Å–ø–∏—Ä–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏ —É—á–∞—Å—Ç—ä—Ü–∏."
    }
    </script>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button id="themeToggle" class="theme-toggle" title="–ü—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ —Ç–µ–º–∞">
        <svg id="themeIcon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
        </svg>
    </button>
    
    <div class="container">
        <div class="card center" id="avgCard">
            <h1 class="title">üìç <span>–°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç</span></h1>
            <div class="big" id="avgSpeedValue">0<span class="unit"> km/h</span></div>
        </div>

        <div class="card center">
            <div class="title">üß≠ <span>–¢–µ–∫—É—â–∞ —Å–∫–æ—Ä–æ—Å—Ç</span></div>
            <div class="medium" id="currentSpeed">0 km/h</div>

            <div class="kpis" style="margin-top:14px;">
                <div class="box">
                    <div class="muted" style="font-weight:600;">–†–∞–∑—Å—Ç–æ—è–Ω–∏–µ</div>
                    <div id="distanceKm">0 m</div>
                </div>
                <div class="box">
                    <div class="muted" style="font-weight:600;">–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</div>
                    <div id="durationMin">0:00</div>
                </div>
            </div>

            <div class="rangeBox">
                <div class="muted" style="font-weight:600;">–ê–∫—Ç–∏–≤–µ–Ω —É—á–∞—Å—Ç—ä–∫</div>
                <div id="activeRange">...</div>
            </div>

            <div style="display:flex; gap:12px; margin-top:16px;">
                <button class="btn" id="startBtn">–°—Ç–∞—Ä—Ç</button>
                <button class="btn secondary" id="resetBtn" title="–ù—É–ª–∏—Ä–∞–Ω–µ">–ù—É–ª–∏—Ä–∞–Ω–µ</button>
            </div>
        </div>

        <table class="dataTable" id="rangesTable" style="margin-top:8px;">
            <thead>
                <tr>
                    <th>–ü—ä—Ç</th>
                    <th>–ù–∞—á–∞–ª–æ</th>
                    <th>–ö—Ä–∞–π</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="footer">
            –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –Ω–∞ —Å–≤–æ–π —Ä–∏—Å–∫. –†–∞–±–æ—Ç–∏ –æ—Ñ–ª–∞–π–Ω —Å–ª–µ–¥ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ. |
            –ö–æ–Ω—Ç–∞–∫—Ç: <a href="mailto:slavi104@gmail.com">slavi104@gmail.com</a> |
            <a href="privacy.html" style="color:#86efac; text-decoration:none;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∑–∞ –ø–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</a> |
            <a href="terms.html" style="color:#86efac; text-decoration:none;">–£—Å–ª–æ–≤–∏—è –∑–∞ –ø–æ–ª–∑–≤–∞–Ω–µ</a> |
            <button id="cookieSettings" class="btn secondary" style="padding:6px 10px; font-size:12px; border-radius:8px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ –±–∏—Å–∫–≤–∏—Ç–∫–∏</button>
        </div>
    </div>

    <!-- Cookie consent banner -->
    <div id="cookieBanner" class="cookie-banner">
        <div class="text">
            –ò–∑–ø–æ–ª–∑–≤–∞–º–µ –±–∏—Å–∫–≤–∏—Ç–∫–∏ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∫–ª–∞–º–∏ (Google AdSense). –ú–æ–∂–µ—Ç–µ –¥–∞ –ø—Ä–∏–µ–º–µ—Ç–µ –∏–ª–∏ –¥–∞ –æ—Ç–∫–∞–∂–µ—Ç–µ —Ä–µ–∫–ª–∞–º–Ω–∏ –±–∏—Å–∫–≤–∏—Ç–∫–∏. –ü–æ–≤–µ—á–µ –≤ <a href="privacy.html" style="color:#86efac;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∑–∞ –ø–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</a>.
        </div>
        <div class="actions">
            <button id="cookieReject" class="btn secondary inline" type="button">–û—Ç–∫–∞–∑–≤–∞–º</button>
            <button id="cookieAccept" class="btn inline" type="button">–ü—Ä–∏–µ–º–∞–º</button>
        </div>
    </div>

    <script>
    // ===== Configuration =====
    // Where to add hardcoded start/end coordinates:
    // Edit the "ROAD_RANGES" array below. Each item has name, start, end.
    // Coordinates are [lat, lon]. The calculator auto-starts when within
    // start.radiusMeters of start point and will stop at end point.
    const ROAD_RANGES = [
        // Example (replace with precise coordinates)
        // { road:"AM \"Trakia\"", label:"Vakarel ‚Üí Ihtiman", start:{lat:42.5999, lon:23.7320, radiusMeters:400}, end:{lat:42.4330, lon:23.8220, radiusMeters:400} },

        // ===== Paste your ranges here =====
        // NOTE: The following are placeholders. Replace with accurate coordinates for each km marker.
        { road:"AM \"Trakia\"", label:"Vakarel (km 24+288) ‚Üí Ihtiman (km 43+448)", start:{lat:42.5667, lon:23.9333, radiusMeters:500}, end:{lat:42.4367, lon:23.8189, radiusMeters:500} },
        { road:"AM \"Trakia\"", label:"Ihtiman (km 43+448) ‚Üí Vakarel (km 24+288)", start:{lat:42.4367, lon:23.8189, radiusMeters:500}, end:{lat:42.5667, lon:23.9333, radiusMeters:500} },
        { road:"AM \"Trakia\"", label:"Tsalapitsa (km 107+663) ‚Üí Radinovo (km 118+599)", start:{lat:42.1500, lon:24.5833, radiusMeters:500}, end:{lat:42.1167, lon:24.6000, radiusMeters:500} },
        { road:"AM \"Trakia\"", label:"Radinovo (km 118+599) ‚Üí Tsalapitsa (km 107+663)", start:{lat:42.1167, lon:24.6000, radiusMeters:500}, end:{lat:42.1500, lon:24.5833, radiusMeters:500} },
        { road:"AM \"Hemus\"", label:"Belokopitovo (km 340+293) ‚Üí Kaspichan (km 361+581)", start:{lat:43.2667, lon:27.0000, radiusMeters:600}, end:{lat:43.3167, lon:27.2000, radiusMeters:600} },
        { road:"AM \"Hemus\"", label:"Kaspichan (km 361+581) ‚Üí Belokopitovo (km 340+293)", start:{lat:43.3167, lon:27.2000, radiusMeters:600}, end:{lat:43.2667, lon:27.0000, radiusMeters:600} },
        { road:"AM \"Hemus\"", label:"Devnya (km 399+703) ‚Üí Ignatievo (km 418+126)", start:{lat:43.2167, lon:27.6000, radiusMeters:600}, end:{lat:43.2660, lon:27.7000, radiusMeters:600} },
        { road:"AM \"Hemus\"", label:"Ignatievo (km 418+126) ‚Üí Devnya (km 399+703)", start:{lat:43.2660, lon:27.7000, radiusMeters:600}, end:{lat:43.2167, lon:27.6000, radiusMeters:600} },
        { road:"AM \"Struma\"", label:"Sandanski (km 143+945) ‚Üí Damyanitsa (km 151+251)", start:{lat:41.5667, lon:23.2833, radiusMeters:500}, end:{lat:41.5660, lon:23.2167, radiusMeters:500} },
        { road:"AM \"Struma\"", label:"Damyanitsa (km 151+251) ‚Üí Sandanski (km 143+945)", start:{lat:41.5660, lon:23.2167, radiusMeters:500}, end:{lat:41.5667, lon:23.2833, radiusMeters:500} },
        { road:"AM \"Struma\"", label:"Balgarchevo (km 90+219) ‚Üí Pokrovnik (km 92+548)", start:{lat:41.9833, lon:23.0667, radiusMeters:500}, end:{lat:41.9833, lon:23.0500, radiusMeters:500} },
        { road:"AM \"Struma\"", label:"Pokrovnik (km 92+548) ‚Üí Balgarchevo (km 90+219)", start:{lat:41.9833, lon:23.0500, radiusMeters:500}, end:{lat:41.9833, lon:23.0667, radiusMeters:500} },
        { road:"Northern Speed Tangent", label:"between 18 and Iliyantsi IC (km 50+427) ‚Üí Chepintsi (km 60+705)", start:{lat:42.7370, lon:23.3230, radiusMeters:500}, end:{lat:42.7615, lon:23.3820, radiusMeters:500} },
        { road:"Northern Speed Tangent", label:"Chepintsi (km 60+705) ‚Üí between 18 and Iliyantsi IC (km 50+427)", start:{lat:42.7615, lon:23.3820, radiusMeters:500}, end:{lat:42.7370, lon:23.3230, radiusMeters:500} },
        { road:"I-1", label:"Slatino (km 343+292) ‚Üí Kocherinovo (km 353+878)", start:{lat:42.1167, lon:23.1333, radiusMeters:600}, end:{lat:42.0833, lon:23.0667, radiusMeters:600} },
        { road:"I-1", label:"Kocherinovo (km 353+878) ‚Üí Slatino (km 343+292)", start:{lat:42.0833, lon:23.0667, radiusMeters:600}, end:{lat:42.1167, lon:23.1333, radiusMeters:600} },
        { road:"I-2", label:"Struyno (km 104+733) ‚Üí Shumen (km 112+381)", start:{lat:43.3333, lon:26.9333, radiusMeters:600}, end:{lat:43.2833, lon:26.9333, radiusMeters:600} },
        { road:"I-2", label:"Shumen (km 112+381) ‚Üí Struyno (km 104+733)", start:{lat:43.2833, lon:26.9333, radiusMeters:600}, end:{lat:43.3333, lon:26.9333, radiusMeters:600} },
        { road:"I-3", label:"Dolni Dabnik (km 100+471) ‚Üí Telish (km 122+349)", start:{lat:43.3833, lon:24.4333, radiusMeters:700}, end:{lat:43.2833, lon:24.2000, radiusMeters:700} },
        { road:"I-3", label:"Telish (km 122+349) ‚Üí Dolni Dabnik (km 100+471)", start:{lat:43.2833, lon:24.2000, radiusMeters:700}, end:{lat:43.3833, lon:24.4333, radiusMeters:700} },
        { road:"I-4", label:"Balgarski Izvor (km 13+536) ‚Üí Sopot (km 22+734)", start:{lat:43.0000, lon:24.2167, radiusMeters:600}, end:{lat:42.9000, lon:24.7167, radiusMeters:600} },
        { road:"I-4", label:"Sopot (km 22+734) ‚Üí Balgarski Izvor (km 13+536)", start:{lat:42.9000, lon:24.7167, radiusMeters:600}, end:{lat:43.0000, lon:24.2167, radiusMeters:600} },
    ];

    // Minimum speed to consider movement (m/s) to filter GPS noise when stopped
    const MOVING_THRESHOLD_MS = 0.8;
    // Minimum distance jump to count (meters)
    const MIN_SEGMENT_METERS = 2.5;

    // ===== Helpers =====
    const el = (id)=>document.getElementById(id);
    function haversineMeters(lat1, lon1, lat2, lon2){
        const R = 6371000; // Earth radius meters
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R*c;
    }
    function metersPerSecondToKmh(ms){ return ms * 3.6; }
    function format2(n){ return (Math.round(n*100)/100).toFixed(2); }

    function isWithin(point, target){
        const d = haversineMeters(point.lat, point.lon, target.lat, target.lon);
        return d <= (target.radiusMeters || 300);
    }

    // ===== State =====
    const state = {
        watchId: null,
        pollId: null,
        gpsPending: false,
        tracking: false,
        startedAt: null,
        elapsedMsAccumulated: 0,
        lastFix: null,
        lastKnown: null,
        distanceMeters: 0,
        activeRange: null, // object from ROAD_RANGES
        awaitingStart: true,
        lastStartTriggerIdx: null,
        lastStartTriggerTs: 0,
    };

    // ===== Core logic =====
    function startManual(){
        state.tracking = true; state.awaitingStart = false; state.startedAt = Date.now(); state.elapsedMsAccumulated = 0; state.distanceMeters = 0; state.lastFix = null;
        updateUi();
    }
    function stopTracking(){
        if(state.tracking && state.startedAt){
            state.elapsedMsAccumulated += (Date.now() - state.startedAt);
        }
        state.tracking = false; state.startedAt = null;
    }
    function resetAll(){
        state.tracking = false; state.awaitingStart = true; state.startedAt = null; state.elapsedMsAccumulated = 0; state.distanceMeters = 0; state.lastFix = null; state.activeRange = null;
        updateUi();
    }

    function ensureWatch(){
        if(state.watchId!=null) return;
        if(!('geolocation' in navigator)) { alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è—Ç–∞ –Ω–µ –µ –Ω–∞–ª–∏—á–Ω–∞.'); return; }
        state.watchId = navigator.geolocation.watchPosition(onPosition, onError, {
            enableHighAccuracy:true, maximumAge:1000, timeout:10000
        });
    }

    function detectActiveRangeIndex(lat, lon){
        const here = {lat, lon};
        for(let i=0;i<ROAD_RANGES.length;i++){
            const r = ROAD_RANGES[i];
            if(isWithin(here, r.start) || isWithin(here, r.end)) return i;
        }
        return -1;
    }

    function forceRestartTracking(){
        stopTracking();
        state.distanceMeters = 0;
        state.elapsedMsAccumulated = 0;
        state.lastFix = null;
        startManual();
    }

    function handleRangeLogic(lat, lon){
        const now = Date.now();
        const idx = detectActiveRangeIndex(lat, lon);
        state.activeRange = idx >= 0 ? ROAD_RANGES[idx] : null;
        if(idx >= 0){
            const r = ROAD_RANGES[idx];
            const atStart = isWithin({lat, lon}, r.start);
            const atEnd = isWithin({lat, lon}, r.end);
            if(atStart){
                const recentlyTriggeredSame = (state.lastStartTriggerIdx === idx) && (now - state.lastStartTriggerTs < 10000);
                if(!recentlyTriggeredSame){
                    if(state.tracking){
                        forceRestartTracking();
                    } else {
                        startManual();
                    }
                    state.lastStartTriggerIdx = idx; state.lastStartTriggerTs = now; state.awaitingStart = false;
                }
            }
            if(atEnd && state.tracking){
                stopTracking();
                state.awaitingStart = true;
            }
        } else {
            if(!state.tracking){ state.awaitingStart = true; }
        }
    }

    // Poll location every second to ensure real-time updates
    function startPolling(){
        if(state.pollId!=null) return;
        if(!('geolocation' in navigator)) { alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è—Ç–∞ –Ω–µ –µ –Ω–∞–ª–∏—á–Ω–∞.'); return; }
        // Start a single continuous watch to avoid repeated permission prompts
        ensureWatch();
        // Refresh UI every second so average speed progresses with time
        state.pollId = setInterval(()=>{
            if(state.lastKnown){ handleRangeLogic(state.lastKnown.lat, state.lastKnown.lon); }
            updateUi();
        }, 1000);
    }
    function stopPolling(){ if(state.pollId!=null){ clearInterval(state.pollId); state.pollId=null; } }

    function onError(err){ console.warn('Geolocation error', err); }

    function detectActiveRange(lat, lon){
        const here = {lat, lon};
        for(const r of ROAD_RANGES){
            if(isWithin(here, r.start) || isWithin(here, r.end)){
                return r;
            }
        }
        return null;
    }

    function onPosition(pos){
        const {latitude:lat, longitude:lon, speed} = pos.coords; // speed in m/s (may be null)
        const now = Date.now();

        // Save last known and run range logic on every fix
        state.lastKnown = {lat, lon};
        handleRangeLogic(lat, lon);

        // Distance accumulation
        if(state.tracking){
            if(state.lastFix){
                const d = haversineMeters(state.lastFix.lat, state.lastFix.lon, lat, lon);
                if(d >= MIN_SEGMENT_METERS){
                    state.distanceMeters += d;
                }
            }
            state.lastFix = {lat, lon, t: now};
        }

        // UI speeds
        const currentMs = (typeof speed === 'number' && !Number.isNaN(speed)) ? Math.max(0, speed) : 0;
        const currentKmh = metersPerSecondToKmh(currentMs);
        el('currentSpeed').textContent = `${Math.round(currentKmh)} km/h`;

        updateUi();
    }

    function updateUi(){
        // Duration
        let elapsedMs = state.elapsedMsAccumulated + (state.tracking && state.startedAt ? (Date.now()-state.startedAt) : 0);
        let totalSeconds = Math.floor(elapsedMs/1000);
        const minutes = Math.floor(totalSeconds/60);
        const seconds = totalSeconds % 60;
        el('durationMin').textContent = `${minutes}:${String(seconds).padStart(2,'0')}`;
        const meters = Math.round(state.distanceMeters);
        if(meters < 1000){
            el('distanceKm').textContent = `${meters} m`;
        } else {
            const km = state.distanceMeters/1000;
            // Show km with one decimal below 10 km, otherwise two decimals
            const formattedKm = km < 10 ? (Math.round(km*10)/10).toFixed(1) : (Math.round(km*100)/100).toFixed(2);
            el('distanceKm').textContent = `${formattedKm} km`;
        }

        // Average speed = distance / duration (use accumulated time)
        let avgKmh = 0;
        if(elapsedMs>0){
            const hours = elapsedMs/3600000;
            avgKmh = (state.distanceMeters/1000) / hours;
        }
        el('avgSpeedValue').innerHTML = `${Number.isFinite(avgKmh)?Math.round(avgKmh):0}<span class="unit"> km/h</span>`;

        // Range label + visual cue
        const rangeBox = document.querySelector('.rangeBox');
        el('activeRange').textContent = state.activeRange ? `${state.activeRange.road} ‚Äî ${state.activeRange.label}` : '–ù—è–º–∞ –∞–∫—Ç–∏–≤–µ–Ω —É—á–∞—Å—Ç—ä–∫';
        if(rangeBox){
            if(state.activeRange){ rangeBox.classList.add('active'); } else { rangeBox.classList.remove('active'); }
        }
        // Highlight active row in table
        const tbody = document.querySelector('#rangesTable tbody');
        if(tbody){
            for(const tr of Array.from(tbody.children)) tr.classList.remove('active');
            if(state.activeRange){
                const idx = ROAD_RANGES.indexOf(state.activeRange);
                const row = tbody.querySelector(`tr[data-idx="${idx}"]`);
                if(row) row.classList.add('active');
            }
        }

        // Buttons
        const startBtn = el('startBtn');
        startBtn.disabled = false;
        if(state.tracking){
            startBtn.classList.add('danger');
            startBtn.textContent = '–°—Ç–æ–ø';
        } else {
            startBtn.classList.remove('danger');
            startBtn.textContent = '–°—Ç–∞—Ä—Ç';
        }
    }

    // ===== UI wiring =====
    el('startBtn').addEventListener('click', ()=>{ if(state.tracking){ stopTracking(); } else { startManual(); } updateUi(); });
    el('resetBtn').addEventListener('click', ()=>{ resetAll(); });
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ startPolling(); } else { stopPolling(); } });

    // Kickoff
    startPolling();
    updateUi();
    // Build ranges table
    (function buildTable(){
        const tbody = document.querySelector('#rangesTable tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        ROAD_RANGES.forEach((r, i)=>{
            const tr = document.createElement('tr');
            tr.setAttribute('data-idx', String(i));
            tr.innerHTML = `
                <td>${r.road}</td>
                <td>${r.label.split('‚Üí')[0].trim()}</td>
                <td>${r.label.split('‚Üí')[1].trim()}</td>
            `;
            tbody.appendChild(tr);
        });
    })();
    </script>
    <script>
    // ===== Consent & AdSense loader =====
    (function(){
        const CONSENT_KEY = 'cookie_consent_v1';
        function getConsent(){ try { return localStorage.getItem(CONSENT_KEY); } catch(e){ return null; } }
        function setConsent(value){ try { localStorage.setItem(CONSENT_KEY, value); } catch(e){} }
        function loadAdsense(){
            if(document.getElementById('adsbygoogle-js')) return;
            var s = document.createElement('script');
            s.async = true;
            s.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5938719335702831';
            s.crossOrigin = 'anonymous';
            s.id = 'adsbygoogle-js';
            document.head.appendChild(s);
        }
        function showBanner(){ var b = document.getElementById('cookieBanner'); if(b){ b.style.display = 'flex'; } }
        function hideBanner(){ var b = document.getElementById('cookieBanner'); if(b){ b.style.display = 'none'; } }

        // Wire UI
        var acceptBtn = document.getElementById('cookieAccept');
        var rejectBtn = document.getElementById('cookieReject');
        var settingsBtn = document.getElementById('cookieSettings');
        if(acceptBtn){ acceptBtn.addEventListener('click', function(){ setConsent('accepted'); hideBanner(); loadAdsense(); }); }
        if(rejectBtn){ rejectBtn.addEventListener('click', function(){ setConsent('rejected'); hideBanner(); }); }
        if(settingsBtn){ settingsBtn.addEventListener('click', function(){ showBanner(); }); }

        // Init
        var c = getConsent();
        if(c === 'accepted') { 
            loadAdsense(); 
            hideBanner(); 
        } else if(c === 'rejected') {
            hideBanner();
        }
        // Banner is visible by default, only hide if consent was already given
    })();
    </script>
    
    <!-- Theme Toggle Script -->
    <script>
    (function(){
        const THEME_KEY = 'theme_preference';
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        // Sun and Moon SVG paths
        const sunIcon = '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>';
        const moonIcon = '<path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>';
        
        function getTheme() {
            try {
                return localStorage.getItem(THEME_KEY) || 'light';
            } catch(e) {
                return 'light';
            }
        }
        
        function setTheme(theme) {
            try {
                localStorage.setItem(THEME_KEY, theme);
            } catch(e) {}
        }
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            if(themeIcon) {
                themeIcon.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
            }
        }
        
        function toggleTheme() {
            const currentTheme = getTheme();
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            applyTheme(newTheme);
        }
        
        // Initialize theme
        const savedTheme = getTheme();
        applyTheme(savedTheme);
        
        // Add click listener
        if(themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
    })();
    </script>
</body>
</html>